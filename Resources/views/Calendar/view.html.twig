{% extends 'OroUIBundle:actions:view.html.twig' %}

{% set format = oro_config_value('oro_locale.name_format') %}
{% set name = entity.owner.fullname(format)|default('N/A') %}
{% oro_title_set({params : {"%username%": name }}) %}

{% block head_script %}
    {{ parent() }}
{% endblock %}

{% block navButtons %}
{% endblock navButtons %}

{% block pageHeader %}
    {% set breadcrumbs = {'entity': entity, 'indexLabel': 'Calendar', 'entityTitle': name } %}
    {{ parent() }}
{% endblock pageHeader %}

{% block stats %}{% endblock stats %}

{% block content_data %}
    <div class="container-fluid">
        <div class="row-fluid" id="calendar">
            <div class="span3">
                <div class="calendars">
                    <div class="calendar-connections"></div>
                    {% if resource_granted('oro_calendar_connection_view') %}
                    <form action="#">
                        {{ form_row(user_select_form) }}
                    </form>
                    {% endif %}
                </div>
            </div>
            <div class="span9 calendar-events"></div>
        </div>
    </div>

    <script type="text/html" id="template-calendar-connections">
        <ul class="media-list connection-container">
        </ul>
    </script>

    <script type="text/html" id="template-calendar-connection-item">
        <li class="media connection-item"
            <% if (!_.isEmpty(backgroundColor)) { %>
                style="background-color: #<%- backgroundColor %>; border-color: #<%- backgroundColor %>"
            <% } %> >
            <div class="pull-left media-body"
                    <% if (!_.isEmpty(color)) { %> style="color: #<%- color %>"<% } %>
                ><%- calendarName %></div>
            <% if (removable) { %>
            <div class="pull-right icons-holder"><a
                href="javascript: void(0);" class="icons-holder-text no-hash remove-connection-button"
                title="{{ 'Exclude this calendar'|trans }}"><i
                    class="icon-remove hide-text"></i></a></div>
            <% } %>
        </li>
    </script>

    <script type="text/html" id="template-calendar-event">
        {% set data = [
                form_row(event_form.title, {'label': 'Title', 'value': '{title}'}),
                form_row(event_form.start, {'label': 'Start', 'value': '{start}'}),
                form_row(event_form.end, {'label': 'End', 'value': '{end}'}),
                form_row(event_form.allDay, {'label': 'All day event', 'attr': { 'checkedif': 'allDay' } }),
                form_row(event_form.reminder, {'label': 'Reminder', 'attr': { 'checkedif': 'reminder' } }),
            ]
        %}
        <div class="alert alert-error" style="display: none;"></div>
        <form id="{{ event_form.vars.name }}" action="#">
            <fieldset class="form-horizontal">
                {{ UI.scrollSubblock(null, data, true, false) }}
                <div class="widget-actions form-actions" style="display: none;">
                    <% if (id != null && removable) { %>
                    {{
                        UI.deleteButton({
                            'aCss': 'no-hash',
                            'id': 'btn-remove-calendarevent',
                            'dataMessage': 'Are you sure you want to delete this event?',
                            'title': 'Delete event',
                            'label': 'Delete'
                        })
                    }}
                    <% } %>
                    <button class="btn" type="reset">{{ 'Cancel'|trans }}</button>
                    <% if (id == null || (id != null && editable)) { %>
                    <button class="btn btn-primary" type="submit">{{ 'Save'|trans }}</button>
                    <% } %>
                </div>
            </fieldset>
        </form>
    </script>

    <script type="text/javascript">
        require(['jquery', 'underscore', 'oro/calendar', 'oro/calendar/event-collection', 'oro/calendar/connection-collection'],
                function($, _, Calendar, CalendarEventCollection, CalendarConnectionCollection){
                    var connections = new CalendarConnectionCollection();
                    connections.reset({{ render(path('oro_api_get_calendar_connections', {id: entity.id})) }});
                    var events = new CalendarEventCollection();
                    events.reset({{ render(path('oro_api_get_calendarevents', {calendar: entity.id, start: startDate|date('c'), end: endDate|date('c'), subordinate: true})) }});
                    var options = {
                        el: '#calendar',
                        collection: events,
                        connections: connections,
                        calendar: {{ entity.id }},
                        subordinate: true,
                        eventFormValidationScriptUrl: '{{ JSFV(event_form, true) }}'
                    };
                    _.extend(options, {{ calendar|json_encode|raw }});
                    var calendar = new Calendar(options);
                  });
    </script>
{% endblock content_data %}
